---
- name: Setup and Deploy Node.js API
  hosts: nodes
  become: yes
  vars:
    app_path: /home/adminuser/ansible-setup/src/movie-analyst-api

  tasks:
    - name: Ensure curl is installed
      apt:
        name: curl
        state: present
        update_cache: true

    - name: Install NVM and Node.js
      shell: |
        export NVM_DIR="$HOME/.nvm"
        if [ ! -d "$NVM_DIR" ]; then
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
        fi
        source "$NVM_DIR/nvm.sh"
        nvm install 16
        nvm alias default 16
      args:
        executable: /bin/bash

    - name: Ensure API code directory exists
      ansible.builtin.stat:
        path: /home/adminuser/ansible-setup/src/movie-analyst-api
      register: api_dir

    - name: Fail if API code not found
      ansible.builtin.fail:
        msg: "API source code not found in /home/adminuser/ansible-setup/src/movie-analyst-api"
      when: not api_dir.stat.exists

    - name: Ensure destination directory exists
      file:
        path: /home/adminuser/ansible-setup/src/
        state: directory
        mode: '0755'

    - name: Copy API source code from jumphost to each node
      synchronize:
        src: /home/adminuser/ansible-setup/src/movie-analyst-api/
        dest: /home/adminuser/ansible-setup/src/movie-analyst-api/
        recursive: yes
        mode: push
      delegate_to: jumpbox

    - name: Install app dependencies
      shell: |
        export NVM_DIR="$HOME/.nvm"
        source "$NVM_DIR/nvm.sh"
        cd /home/adminuser/ansible-setup/src/movie-analyst-api
        npm install
      args:
        executable: /bin/bash

