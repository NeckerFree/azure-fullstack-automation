---
- name: Prepare target nodes for API deployment via CI/CD
  hosts: nodes
  gather_facts: yes 
  become: yes
  vars:
    service_name: "movie-analyst-api"
    app_dir: "/opt/{{ service_name }}"
    ansible_python_interpreter: /usr/bin/python3
  tasks:
    - name: Ensure connectivity
      ping:
    # --- Node.js Setup ---
    - name: Install Node.js and npm
      apt:
        name:
          - nodejs
          - npm
        update_cache: yes
        state: present

    # --- Directory Structure ---
    - name: Ensure app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "www-data"
        group: "www-data"
        mode: "0755"

    # --- Service Configuration ---
    - name: Deploy systemd service file
      template:
        src: "templates/movie-api.service.j2"
        dest: "/etc/systemd/system/{{ service_name }}.service"
        mode: "0644"
      notify:
        - Reload systemd
        - Restart Movie Analyst API

    - name: Ensure service is enabled and running
      service:
        name: "{{ service_name }}"
        enabled: yes
        state: started

  handlers:
    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Restart Movie Analyst API
      service:
        name: "{{ service_name }}"
        state: restarted
