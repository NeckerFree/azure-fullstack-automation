---
- name: Setup and Deploy Node.js API
  hosts: nodes
  become: yes
  vars:
    app_path: "{{ api_source_path | default('/home/adminuser/ansible-setup/src/movie-analyst-api') }}"

  tasks:
    - name: Ensure curl is installed
      apt:
        name: curl
        state: present
        update_cache: true

    - name: Install NVM and Node.js
      shell: |
        export NVM_DIR="$HOME/.nvm"
        if [ ! -d "$NVM_DIR" ]; then
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
        fi
        source "$NVM_DIR/nvm.sh"
        nvm install 16
        nvm alias default 16
      args:
        executable: /bin/bash

    - name: Ensure API code directory exists on jumphost
      ansible.builtin.stat:
        path: "{{ app_path }}"
      register: api_dir
      delegate_to: jumpbox

    - name: Fail if API code not found on jumphost
      ansible.builtin.fail:
        msg: "API source code not found at {{ app_path }} on jumpbox"
      when: not api_dir.stat.exists
      delegate_to: jumpbox

    - name: Sync API source code from jumphost to target node
      synchronize:
        src: "{{ app_path }}/"
        dest: "{{ app_path }}/"
        recursive: yes
        mode: push
      delegate_to: jumpbox

    - name: Install app dependencies
      shell: |
        export NVM_DIR="$HOME/.nvm"
        source "$NVM_DIR/nvm.sh"
        cd "{{ app_path }}"
        npm install
      args:
        executable: /bin/bash
