---
- name: Setup Movie Analyst API
  hosts: api_servers  # Adjust host group as needed
  become: yes

  tasks:
    - name: Install Node.js and npm
      apt:
        name:
          - nodejs
          - npm
        update_cache: yes
        state: present

    - name: Ensure app directory exists
      file:
        path: "/opt/movie-analyst-api"
        state: directory
        owner: "www-data"
        group: "www-data"
        mode: "0755"

    - name: Copy API source code (including server.js)
      copy:
        src: "{{ api_source_path }}"  # Define this in vars or extra-vars
        dest: "/opt/movie-analyst-api"
        owner: "www-data"
        group: "www-data"
        mode: "0644"
        # Ensure server.js is included in the copied files

    - name: Install API dependencies (including mysql)
      npm:
        path: "/opt/movie-analyst-api"
        state: present

    - name: Setup systemd service for API
      template:
        src: "templates/movie-analyst-api.service.j2"
        dest: "/etc/systemd/system/movie-analyst-api.service"
        mode: "0644"
      notify:
        - Reload systemd
        - Restart Movie Analyst API

    - name: Enable and start API service
      service:
        name: "movie-analyst-api"
        enabled: yes
        state: started

  handlers:
    - name: Reload systemd
      systemd:
   